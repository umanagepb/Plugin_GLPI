<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Timer com Sele√ß√£o de Projeto</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .config-section {
            background: #e9f7ef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .config-section h3 {
            margin-top: 0;
            color: #27ae60;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 5px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        /* Estilos do Modal de Projetos */
        .project-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .project-modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .project-modal h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .project-search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .project-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        .project-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .project-item:hover {
            background-color: #f8f9fa;
        }
        
        .project-item:last-child {
            border-bottom: none;
        }
        
        .project-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .project-client {
            font-size: 12px;
            color: #666;
        }
        
        .project-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .modal-buttons {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .btn-cancel {
            background: #6c757d;
            margin-right: 10px;
        }
        
        .btn-cancel:hover {
            background: #545b62;
        }

        .timer-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .running-timer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üöÄ Teste - Timer Melhorado com Sele√ß√£o de Projeto</h1>
    
    <div class="test-container">
        <h2>‚ú® Funcionalidades Implementadas</h2>
        <ul>
            <li>‚úÖ In√≠cio de timer normal (sem projeto)</li>
            <li>‚úÖ Busca de projetos via API</li>
            <li>‚úÖ Popup de sele√ß√£o de projeto ao parar timer</li>
            <li>‚úÖ Update do time-entry com projeto selecionado</li>
            <li>‚úÖ Parada do timer ap√≥s update</li>
            <li>‚úÖ Filtro de busca nos projetos</li>
            <li>‚úÖ Interface responsiva e amig√°vel</li>
        </ul>
    </div>

    <div class="test-container">
        <div class="config-section">
            <h3>üîë Configura√ß√£o da API</h3>
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" placeholder="Sua API Key do Clockify" />
            
            <label for="workspaceId">Workspace ID:</label>
            <input type="text" id="workspaceId" placeholder="ID do seu workspace" />
        </div>

        <div id="timerStatus" class="timer-info" style="display: none;">
            <h4>‚è±Ô∏è Status do Timer</h4>
            <p id="timerStatusText">Nenhum timer ativo</p>
            <p><strong>ID:</strong> <span id="currentTimerId">-</span></p>
            <p><strong>Descri√ß√£o:</strong> <span id="currentTimerDesc">-</span></p>
            <p><strong>In√≠cio:</strong> <span id="currentTimerStart">-</span></p>
        </div>

        <h3>üß™ Teste do Fluxo Completo</h3>
        <button onclick="startTestTimer()">‚ñ∂Ô∏è 1. Iniciar Timer de Teste</button>
        <button onclick="stopTimerWithProject()" id="stopBtn" disabled>‚èπÔ∏è 2. Parar Timer (com sele√ß√£o de projeto)</button>
        <button onclick="getProjects()">üìã Listar Projetos Dispon√≠veis</button>
        <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
        
        <h3>üìù Log de Atividades</h3>
        <div id="logArea" class="log-area"></div>
    </div>

    <!-- Modal de Sele√ß√£o de Projeto -->
    <div id="projectModal" class="project-modal" style="display: none;">
        <div class="project-modal-content">
            <h3>üìã Selecionar Projeto</h3>
            <p>Escolha um projeto para associar ao seu registro de tempo:</p>
            
            <input type="text" id="projectSearch" class="project-search" placeholder="üîç Buscar projeto..." />
            
            <div id="projectList" class="project-list">
                <!-- Projetos ser√£o inseridos aqui -->
            </div>
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cancelProjectSelection()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('logArea');
        let currentTimer = null;
        let projects = [];
        let selectedProjectId = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logArea.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            logArea.innerHTML = '';
        }
        
        function getConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const workspaceId = document.getElementById('workspaceId').value.trim();
            
            if (!apiKey || !workspaceId) {
                log('‚ùå Erro: Configure a API Key e Workspace ID primeiro!', 'error');
                return null;
            }
            
            return { apiKey, workspaceId };
        }

        function updateTimerStatus(timer) {
            const statusDiv = document.getElementById('timerStatus');
            const statusText = document.getElementById('timerStatusText');
            const timerId = document.getElementById('currentTimerId');
            const timerDesc = document.getElementById('currentTimerDesc');
            const timerStart = document.getElementById('currentTimerStart');
            const stopBtn = document.getElementById('stopBtn');
            
            if (timer) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'running-timer';
                statusText.textContent = 'Timer ativo';
                timerId.textContent = timer.id;
                timerDesc.textContent = timer.description;
                timerStart.textContent = new Date(timer.timeInterval.start).toLocaleString();
                stopBtn.disabled = false;
                currentTimer = timer;
            } else {
                statusDiv.style.display = 'block';
                statusDiv.className = 'timer-info';
                statusText.textContent = 'Nenhum timer ativo';
                timerId.textContent = '-';
                timerDesc.textContent = '-';
                timerStart.textContent = '-';
                stopBtn.disabled = true;
                currentTimer = null;
            }
        }
        
        async function startTestTimer() {
            const config = getConfig();
            if (!config) return;
            
            log('üîÑ Iniciando timer de teste...', 'info');
            
            const data = {
                "start": new Date().toISOString(),
                "description": "TESTE - Timer com sele√ß√£o de projeto"
            };
            
            try {
                const response = await fetch(`https://api.clockify.me/api/v1/workspaces/${config.workspaceId}/time-entries`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Api-Key": config.apiKey,
                    },
                    body: JSON.stringify(data),
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Timer iniciado com sucesso!', 'success');
                    log(`üìÑ ID: ${result.id}`, 'info');
                    log(`üìù Descri√ß√£o: ${result.description}`, 'info');
                    log(`‚è∞ In√≠cio: ${new Date(result.timeInterval.start).toLocaleString()}`, 'info');
                    updateTimerStatus(result);
                } else {
                    log(`‚ùå Erro ao iniciar timer: ${response.status}`, 'error');
                    log(`‚ùå Detalhes: ${JSON.stringify(result)}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
            }
        }

        async function getProjects() {
            const config = getConfig();
            if (!config) return;
            
            log('üîÑ Buscando projetos do workspace...', 'info');
            
            try {
                const response = await fetch(`https://api.clockify.me/api/v1/workspaces/${config.workspaceId}/projects`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Api-Key": config.apiKey,
                    },
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    projects = result;
                    log(`‚úÖ Encontrados ${projects.length} projetos:`, 'success');
                    
                    projects.forEach((project, index) => {
                        log(`   ${index + 1}. ${project.name} (ID: ${project.id})`, 'info');
                        if (project.clientName) {
                            log(`      Cliente: ${project.clientName}`, 'info');
                        }
                    });
                    
                    if (projects.length === 0) {
                        log('‚ö†Ô∏è Nenhum projeto encontrado. Crie projetos no Clockify primeiro.', 'warning');
                    }
                } else {
                    log(`‚ùå Erro ao buscar projetos: ${response.status}`, 'error');
                    log(`‚ùå Detalhes: ${JSON.stringify(result)}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
            }
        }

        function showProjectModal() {
            if (projects.length === 0) {
                log('‚ö†Ô∏è Nenhum projeto carregado. Buscando projetos...', 'warning');
                getProjects().then(() => {
                    if (projects.length > 0) {
                        renderProjectModal();
                    } else {
                        log('‚ùå N√£o foi poss√≠vel carregar os projetos.', 'error');
                    }
                });
                return;
            }
            
            renderProjectModal();
        }

        function renderProjectModal() {
            const modal = document.getElementById('projectModal');
            const projectList = document.getElementById('projectList');
            const searchInput = document.getElementById('projectSearch');
            
            // Limpa lista anterior
            projectList.innerHTML = '';
            searchInput.value = '';
            
            // Adiciona op√ß√£o "Sem projeto"
            const noProjectItem = document.createElement('div');
            noProjectItem.className = 'project-item';
            noProjectItem.innerHTML = `
                <div class="project-name">
                    <span class="project-color" style="background-color: #ccc;"></span>
                    Sem projeto
                </div>
                <div class="project-client">Nenhum projeto ser√° associado</div>
            `;
            noProjectItem.onclick = () => selectProject(null);
            projectList.appendChild(noProjectItem);
            
            // Renderiza projetos
            renderProjects(projects);
            
            // Configura busca
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProjects = projects.filter(project => 
                    project.name.toLowerCase().includes(searchTerm) ||
                    (project.clientName && project.clientName.toLowerCase().includes(searchTerm))
                );
                
                // Limpa e re-renderiza
                projectList.innerHTML = '';
                projectList.appendChild(noProjectItem.cloneNode(true));
                projectList.lastChild.onclick = () => selectProject(null);
                renderProjects(filteredProjects);
            };
            
            modal.style.display = 'flex';
            searchInput.focus();
        }

        function renderProjects(projectsToRender) {
            const projectList = document.getElementById('projectList');
            
            projectsToRender.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'project-item';
                
                const projectColor = project.color || '#007bff';
                const clientInfo = project.clientName ? `<div class="project-client">Cliente: ${project.clientName}</div>` : '';
                
                projectItem.innerHTML = `
                    <div class="project-name">
                        <span class="project-color" style="background-color: ${projectColor};"></span>
                        ${project.name}
                    </div>
                    ${clientInfo}
                `;
                
                projectItem.onclick = () => selectProject(project);
                projectList.appendChild(projectItem);
            });
        }

        function selectProject(project) {
            selectedProjectId = project ? project.id : null;
            const projectName = project ? project.name : 'Sem projeto';
            
            log(`üìã Projeto selecionado: ${projectName}`, 'info');
            if (project) {
                log(`   ID: ${project.id}`, 'info');
                if (project.clientName) {
                    log(`   Cliente: ${project.clientName}`, 'info');
                }
            }
            
            // Fecha modal
            document.getElementById('projectModal').style.display = 'none';
            
            // Prossegue com a parada do timer
            executeStopTimer();
        }

        function cancelProjectSelection() {
            log('‚ùå Sele√ß√£o de projeto cancelada', 'warning');
            document.getElementById('projectModal').style.display = 'none';
            selectedProjectId = null;
        }

        async function stopTimerWithProject() {
            if (!currentTimer) {
                log('‚ùå Nenhum timer ativo para parar', 'error');
                return;
            }
            
            log('üîÑ Iniciando processo de parada do timer...', 'info');
            
            // Primeiro busca projetos se n√£o estiverem carregados
            if (projects.length === 0) {
                await getProjects();
            }
            
            // Mostra modal de sele√ß√£o de projeto
            showProjectModal();
        }

        async function executeStopTimer() {
            const config = getConfig();
            if (!config || !currentTimer) return;
            
            try {
                // Se um projeto foi selecionado, primeiro atualiza o time-entry
                if (selectedProjectId) {
                    log('üîÑ Atualizando time-entry com projeto...', 'info');
                    
                    const updateResponse = await fetch(`https://api.clockify.me/api/v1/workspaces/${config.workspaceId}/time-entries/${currentTimer.id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Api-Key": config.apiKey,
                        },
                        body: JSON.stringify({
                            "start": currentTimer.timeInterval.start,
                            "description": currentTimer.description,
                            "projectId": selectedProjectId
                        }),
                    });
                    
                    if (updateResponse.ok) {
                        const updateResult = await updateResponse.json();
                        log('‚úÖ Time-entry atualizado com projeto!', 'success');
                        
                        const project = projects.find(p => p.id === selectedProjectId);
                        if (project) {
                            log(`üìã Projeto: ${project.name}`, 'info');
                        }
                    } else {
                        const updateError = await updateResponse.json();
                        log(`‚ö†Ô∏è Erro ao atualizar projeto (continuando...): ${updateResponse.status}`, 'warning');
                        log(`‚ùå Detalhes: ${JSON.stringify(updateError)}`, 'warning');
                    }
                }
                
                // Agora para o timer
                log('üîÑ Parando o timer...', 'info');
                
                // Primeiro obt√©m informa√ß√µes do usu√°rio
                const userResponse = await fetch(`https://api.clockify.me/api/v1/user`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Api-Key": config.apiKey,
                    },
                });
                
                if (!userResponse.ok) {
                    throw new Error(`Erro ao obter usu√°rio: ${userResponse.status}`);
                }
                
                const user = await userResponse.json();
                log(`üë§ Usu√°rio: ${user.name} (ID: ${user.id})`, 'info');
                
                // Para o timer
                const stopResponse = await fetch(`https://api.clockify.me/api/v1/workspaces/${config.workspaceId}/user/${user.id}/time-entries`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Api-Key": config.apiKey,
                    },
                    body: JSON.stringify({
                        "end": new Date().toISOString()
                    }),
                });
                
                if (stopResponse.ok) {
                    const stopResult = await stopResponse.json();
                    log('üéâ Timer parado com sucesso!', 'success');
                    log(`‚èπÔ∏è Fim: ${new Date(stopResult.timeInterval.end).toLocaleString()}`, 'info');
                    
                    // Calcula dura√ß√£o
                    const start = new Date(stopResult.timeInterval.start);
                    const end = new Date(stopResult.timeInterval.end);
                    const duration = Math.round((end - start) / 1000);
                    const hours = Math.floor(duration / 3600);
                    const minutes = Math.floor((duration % 3600) / 60);
                    const seconds = duration % 60;
                    
                    log(`‚è±Ô∏è Dura√ß√£o: ${hours}h ${minutes}m ${seconds}s`, 'info');
                    
                    updateTimerStatus(null);
                } else {
                    const stopError = await stopResponse.json();
                    log(`‚ùå Erro ao parar timer: ${stopResponse.status}`, 'error');
                    log(`‚ùå Detalhes: ${JSON.stringify(stopError)}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro durante processo de parada: ${error.message}`, 'error');
            } finally {
                selectedProjectId = null;
            }
        }

        // Modal - clique fora para fechar
        document.getElementById('projectModal').onclick = (e) => {
            if (e.target === document.getElementById('projectModal')) {
                cancelProjectSelection();
            }
        };

        // Tecla ESC para fechar modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('projectModal').style.display === 'flex') {
                cancelProjectSelection();
            }
        });
        
        // Log inicial
        log('üöÄ Sistema de timer melhorado carregado!', 'success');
        log('üìã Funcionalidades: start ‚Üí select project ‚Üí update ‚Üí stop', 'info');
        log('üîß Configure suas credenciais e teste o fluxo completo.', 'info');
        log('', 'info');
    </script>
</body>
</html>
